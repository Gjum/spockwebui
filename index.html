<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Spock UI</title>
    <style type="text/css">
        path.gauge {
            stroke-width: 5px;
            fill: none;
        }

        path.gaugeOutline {
            stroke: #555555;
        }

        path.gaugeValue {
            stroke: #1385ff;
        }

        body {
            background-color: #333639;
        }
    </style>
</head>
<body onload="init()">
<script type="text/javascript">
    function polarToCartesian(centerX, centerY, radius, angleInDegrees) {
        var angleInRadians = (angleInDegrees - 90) * Math.PI / 180.0;
        return {
            x: centerX + (radius * Math.cos(angleInRadians)),
            y: centerY + (radius * Math.sin(angleInRadians))
        };
    }

    function describeArc(x, y, radius, startAngle, endAngle) {
        var start = polarToCartesian(x, y, radius, startAngle);
        var end = polarToCartesian(x, y, radius, endAngle);

        var deltaAngle = (endAngle - startAngle);
        var largeArc = Math.abs(deltaAngle) % 360 >= 180 ? "1" : "0";
        var arcSweep = deltaAngle >= 0 ? "1" : "0";

        return [
            "M", start.x, start.y,
            "A", radius, radius, 0, largeArc, arcSweep, end.x, end.y
        ].join(" ");
    }

    function setObjAttr(attr, val) {
        this[attr] = val;
        return this;
    }

    function Gauge(id) {
        this.radius = 50;
        this.blur = 3;
        this.startAngle = 240;
        this.sizeAngle = 240;

        this.targetVal = 0;
        var drawnVal = 0;
        var speed = 0;
        var timeoutId = null;

        var outlineElement = null;
        var valueElement = null;
        var svgElement = null;

        this.set = setObjAttr;
        var self = this;

        this.setValue = function (newVal, immediate) {
            if (1 < newVal && newVal <= 100) newVal *= 0.01;
            else if (newVal < 0 || 100 < newVal) {
                console.warn(id, "Ignoring out of range value ", newVal);
                return;
            }

            if (timeoutId) window.clearTimeout(timeoutId);

            if (immediate) {
                self.targetVal = drawnVal = newVal;
                updateValueElement();
            } else {
                self.targetVal = newVal;
                interpolateTick();
            }

            return this;

            function interpolateTick() {
                var deltaVal = drawnVal - self.targetVal;
                var arcPixel = self.sizeAngle / 360 * 6.28 * self.radius;
                var deltaPixel = deltaVal * arcPixel;
                console.log("deltaPixel", deltaPixel);
                //  TODO use animation helper

                if (Math.abs(deltaPixel) > 1) {
                    var minTimeout = 20;
                    var progress = .2;
                    drawnVal = drawnVal * (1 - progress)
                            + self.targetVal * progress;
                    updateValueElement();
                    timeoutId = window.setTimeout(interpolateTick, 50);
                } else { // interpolation done
                    // close enough to finish
                    drawnVal = self.targetVal;
                    updateValueElement();
                }
            }

            function updateValueElement() {
                if (!valueElement) return;
                valueElement.setAttribute("d", describeArc(0, 0, self.radius,
                        self.startAngle, self.startAngle + self.sizeAngle * drawnVal));
            }
        };

        this.addToBody = function () {
            if (outlineElement) {
                console.warn(id, "Already added to body");
                return this;
            }

            var boxRadius = this.radius + 10;
            var width = 2 * boxRadius;
            var height = 2 * boxRadius;
            var viewBox = [-boxRadius, -boxRadius, width, height].join(" ");

            var svgNS = "http://www.w3.org/2000/svg";

            outlineElement = document.createElementNS(svgNS, "path");
            outlineElement.setAttribute("class", "gauge gaugeOutline");
            outlineElement.setAttribute("d", describeArc(0, 0,
                    this.radius, this.startAngle, this.startAngle + this.sizeAngle));

            valueElement = document.createElementNS(svgNS, "path");
            valueElement.setAttribute("class", "gauge gaugeValue");

            svgElement = document.createElementNS(svgNS, "svg");
            svgElement.setAttribute("width", width + "px");
            svgElement.setAttribute("height", height + "px");
            svgElement.setAttribute("viewBox", viewBox);
            svgElement.appendChild(outlineElement);
            svgElement.appendChild(valueElement);
            document.body.appendChild(svgElement);

            if (this.blur) {
                var blurId = "filterBlur" + id;

                var blur = document.createElementNS(svgNS, "feGaussianBlur");
                blur.setAttribute("in", "SourceGraphic");
                blur.setAttribute("stdDeviation", this.blur);

                var filter = document.createElementNS(svgNS, "filter");
                filter.setAttribute("id", blurId);
                filter.appendChild(blur);

                svgElement.appendChild(filter);
                valueElement.setAttribute("filter", "url(#" + blurId + ")");
            }

            this.setValue(drawnVal, "immediate");
            return this;
        };

    }

    function init() {

        var fooGauge = new Gauge("foo")
                .set("radius", 100)
                .set("startAngle", 480)
                .set("sizeAngle", -240)
                .addToBody()
                .setValue(.2, "immediate")
                .setValue(.8);

//        var counter = 0;
//        var inter = (1 - Math.abs((counter % 100) / 50 - 1))
//        counter += 1


        var messagesElement = document.createElement('ul');
        ws.onmessage = function (event) {
            var message = document.createElement('li');
            var content = document.createTextNode(event.data);
            message.appendChild(content);
            messagesElement.appendChild(message);
        };
        document.body.appendChild(messagesElement);

    }

    var ws = new WebSocket("ws://127.0.0.1:5678/");

    function onCommand() {
        var command = document.getElementById("commandText").textContent;
        ws.send("command:" + command);
    }
</script>
<script>
    new Gauge("first")
            .addToBody()
            .setValue(.8, "immediate")
            .setValue(.2)
</script>

</body>
</html>
